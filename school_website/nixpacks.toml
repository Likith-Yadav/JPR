[phases.setup]
nixPkgs = [
    'python311',
    'python311Packages.pip',
    'python311Packages.virtualenv',
    'pango',
    'libffi',
    'cairo',
    'gobject-introspection',
    'libpng',
    'gdk-pixbuf',
    'freetype',
    'fontconfig',
    'harfbuzz',
    'fribidi',
    'libxml2',
    'libxslt',
    'libjpeg',
    'libtiff',
    'libwebp',
    'zlib',
    'brotli',
    'woff2',
    'libunwind',
    'glib',
    'gobject-introspection',
    'pkg-config',
    'gobject-introspection-unwrapped',
    'gobject-introspection-unwrapped.dev'
]

[phases.install]
cmds = [
    'mkdir -p /usr/lib',
    'echo "Setting up pkg-config paths..."',
    'PKG_CONFIG_PATHS=$(find /nix/store -name "*.pc" -type f -exec dirname {} \; | sort -u)',
    'export PKG_CONFIG_PATH=$PKG_CONFIG_PATHS',
    'echo "PKG_CONFIG_PATH set to: $PKG_CONFIG_PATH"',
    'echo "Setting up GObject libraries..."',
    'GLIB_PATH=$(pkg-config --variable=libdir gobject-2.0)',
    'if [ -z "$GLIB_PATH" ]; then echo "Error: Could not find GObject library path"; exit 1; fi',
    'echo "Found GObject library path: $GLIB_PATH"',
    'GOBJECT_SO="$GLIB_PATH/libgobject-2.0.so"',
    'if [ ! -f "$GOBJECT_SO" ]; then echo "Error: GObject library not found at $GOBJECT_SO"; exit 1; fi',
    'echo "Found GObject library at: $GOBJECT_SO"',
    'ln -sf "$GOBJECT_SO" /usr/lib/libgobject-2.0-0.so',
    'ln -sf "$GOBJECT_SO" /usr/lib/libgobject-2.0.so',
    'ln -sf "$GOBJECT_SO" /usr/lib/libgobject-2.0.so.0',
    'export LD_LIBRARY_PATH=/usr/lib:/usr/local/lib:/nix/store/*/lib:/nix/store/*/lib64',
    'export GI_TYPELIB_PATH=/usr/lib/girepository-1.0:/nix/store/*/lib/girepository-1.0:/nix/store/*/lib64/girepository-1.0',
    'export LIBRARY_PATH=/usr/lib:/usr/local/lib:/nix/store/*/lib:/nix/store/*/lib64',
    'export C_INCLUDE_PATH=/nix/store/*/include',
    'export CPLUS_INCLUDE_PATH=/nix/store/*/include',
    'export PATH=/nix/store/*/bin:/nix/store/*/lib/gobject-introspection:$PATH',
    'ldconfig'
] 